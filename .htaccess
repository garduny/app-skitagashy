#########################################
# üö´ Deny Access to Sensitive Files
#########################################
<FilesMatch "^(php_errors\.log|\.env|composer\.(json|lock)|\.git|\.htaccess|README\.md)$">
  Require all denied
</FilesMatch>

#########################################
# ‚öô PHP Configuration
#########################################
php_value memory_limit 512M
php_value upload_max_filesize 128M
php_value post_max_size 128M
php_value max_execution_time 300
php_value max_input_time 300
php_value max_input_vars 10000

# Session security
php_value session.gc_maxlifetime 604800
php_flag session.cookie_httponly On
php_flag session.cookie_secure On
php_flag session.use_strict_mode On
php_flag session.use_only_cookies On

# Error logging
php_flag display_errors Off
php_flag log_errors On
php_value error_log /var/www/private/logs/php_errors.log

#########################################
# üîß Fix: Pass Authorization Header
#########################################
SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1

#########################################
# üì¶ Compression
#########################################
<IfModule mod_brotli.c>
  AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/xml text/css text/javascript application/javascript application/json image/svg+xml
</IfModule>

<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json image/svg+xml
</IfModule>

#########################################
# üß† Caching Rules
#########################################
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType image/jpg               "access plus 1 year"
  ExpiresByType image/png               "access plus 1 year"
  ExpiresByType image/webp              "access plus 1 year"
  ExpiresByType image/svg+xml           "access plus 1 year"
  ExpiresByType text/css                "access plus 1 month"
  ExpiresByType application/javascript  "access plus 1 month"
  
  # ‚ö†Ô∏è API & JSON (No Cache)
  ExpiresByType application/json        "access plus 0 seconds"
  ExpiresByType text/html               "access plus 0 seconds"
  ExpiresDefault                        "access plus 2 days"
</IfModule>

#########################################
# üîí Headers
#########################################
<IfModule mod_headers.c>
  Header unset ETag
  FileETag None
  Header set Connection keep-alive
  Header always set X-Content-Type-Options "nosniff"
  Header always set X-Frame-Options "SAMEORIGIN"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  Header always set Permissions-Policy "geolocation=(), camera=(), microphone=()"
  
  <FilesMatch "\.(php|json)$">
    Header set Cache-Control "max-age=0, no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
  </FilesMatch>
</IfModule>

#########################################
# üö´ Disable Directory Listing
#########################################
Options -Indexes
DirectoryIndex app.php

#########################################
# üåê Clean URLs & Routing
#########################################
RewriteEngine On

# Allow direct access to existing files/directories
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# Extensionless Routing
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^([^\.]+)$ $1.php [NC,L]

#########################################
# ‚ùå Custom 404 Handling (Environment Specific)
#########################################

# 1. Localhost (Dev) - Adjust 'app-skitagashy' to your folder name
RewriteCond %{HTTP_HOST} ^localhost$ [NC,OR]
RewriteCond %{REMOTE_ADDR} ^127\.0\.0\.1$
RewriteRule ^ /app-skitagashy/404.php [L,R=302]

# 2. Production (Live)
RewriteCond %{HTTP_HOST} !^localhost$ [NC]
RewriteCond %{REMOTE_ADDR} !^127\.0\.0\.1$
RewriteRule ^ /skitagashy/404.php [L,R=302]